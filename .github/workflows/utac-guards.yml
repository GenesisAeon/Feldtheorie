name: UTAC Guards

# PrÃ¼ft UTAC v2.0 Readiness und Preset Alignment
# Entspricht utac-v2-data-lanterns und mq-bridge-shadow-001

on:
  push:
    branches: [ main, 'claude/**' ]
    paths:
      - 'analysis/**'
      - 'simulator/presets/**'
      - 'data/**'
      - 'analysis/reports/utac_v2_readiness.json'
  pull_request:
    branches: [ main ]
    paths:
      - 'analysis/**'
      - 'simulator/presets/**'
      - 'data/**'

jobs:
  preset-alignment:
    runs-on: ubuntu-latest
    name: Preset Alignment Guard

    steps:
    - uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install numpy scipy pandas pyyaml

    - name: Run Preset Alignment Guard
      id: preset_check
      run: |
        echo "ğŸ” Checking simulator presets against analysis exports..."

        # Run the preset alignment guard
        python analysis/preset_alignment_guard.py \
          --root . \
          --presets-dir simulator/presets \
          --rel-tol 0.01

        EXITCODE=$?

        if [ $EXITCODE -eq 0 ]; then
          echo "âœ… PASS: All presets aligned with analysis exports"
          echo "status=aligned" >> $GITHUB_OUTPUT
        else
          echo "âŒ FAIL: Preset misalignment detected!"
          echo "status=misaligned" >> $GITHUB_OUTPUT
          exit 1
        fi

    - name: Summary
      if: success()
      run: |
        echo "âœ… Preset Alignment: PASSED"
        echo ""
        echo "Simulatorâ†”Analysis Bridge remains resonant:"
        echo "  - Î² values: synchronized âœ…"
        echo "  - Î˜ thresholds: aligned âœ…"
        echo "  - Field types: consistent âœ…"
        echo ""
        echo "The bridge holds. Data integrity maintained."

  manifest-gap-scan:
    runs-on: ubuntu-latest
    name: UTAC v2.0 Manifest Gap Scan

    steps:
    - uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install pyyaml

    - name: Run Manifest Gap Scan
      id: gap_scan
      run: |
        echo "ğŸ” Scanning UTAC v2.0 readiness manifest..."

        # Run the gap scanner
        OUTPUT_FILE="/tmp/utac_v2_gap_scan_ci.json"
        python analysis/utac_manifest_gap_scan.py \
          --manifest analysis/reports/utac_v2_readiness.json \
          --output "$OUTPUT_FILE"

        EXITCODE=$?

        # Parse gap count from output
        if [ -f "$OUTPUT_FILE" ]; then
          GAPS=$(python -c "import json; f=open('$OUTPUT_FILE'); d=json.load(f); print(d.get('summary', {}).get('total_gaps', 0))")
          echo "gaps=$GAPS" >> $GITHUB_OUTPUT

          echo ""
          echo "ğŸ“Š Gap Scan Results:"
          cat "$OUTPUT_FILE"
          echo ""
        else
          echo "âš ï¸  Warning: Gap scan output not generated"
          GAPS=0
          echo "gaps=0" >> $GITHUB_OUTPUT
        fi

        # Informational only - don't fail CI
        if [ "$GAPS" -gt 0 ]; then
          echo "âš ï¸  $GAPS gap(s) detected - V2.0 readiness incomplete"
        else
          echo "âœ… No gaps - V2.0 readiness complete!"
        fi

    - name: Check V2.0 Readiness
      run: |
        GAPS=${{ steps.gap_scan.outputs.gaps }}
        echo "ğŸ¯ UTAC v2.0 Readiness: $GAPS gap(s) remaining"

        # This is informational - we don't fail CI
        # (gaps are expected during development)
        if [ "$GAPS" -eq 0 ]; then
          echo "ğŸ‰ FULL ACTIVATION: RÌ„ â‰¥ Î˜ â†’ Ïƒ(Î²(R-Î˜)) â‰ˆ 1.00"
        else
          echo "ğŸ”„ In Progress: RÌ„ approaching Î˜ (0.66)"
          echo ""
          echo "Missing components tracked in v2_roadmap.md"
        fi

    - name: Summary
      if: success()
      run: |
        GAPS=${{ steps.gap_scan.outputs.gaps }}
        echo "ğŸ“‹ UTAC v2.0 Manifest Scan: COMPLETED"
        echo ""
        echo "Current status:"
        echo "  - Gaps detected: $GAPS"
        echo "  - Roadmap: seed/FraktaltagebuchV2/v2_roadmap.md"
        echo "  - Codex: seed/FraktaltagebuchV2/v2_codex.md"
        echo ""
        echo "The field grows. Î²â‰ˆ4.8 guides the transition."
