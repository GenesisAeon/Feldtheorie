name: Sigillin Health Check

# PrÃ¼ft Trilayer-ParitÃ¤t und Index-Synchronisation
# Entspricht sys-gap-001 (Index drift) und sys-gap-003 (Shadow handshake telemetry)

on:
  push:
    branches: [ main, 'claude/**' ]
    paths:
      - 'seed/bedeutungssigillin/**'
      - 'seed/shadow_sigillin/**'
      - 'seed/*_index.*'
      - 'feldtheorie_index.*'
      - 'scripts/sigillin_sync.py'
      - 'scripts/archive_sigillin.py'
  pull_request:
    branches: [ main ]
    paths:
      - 'seed/bedeutungssigillin/**'
      - 'seed/shadow_sigillin/**'
      - 'seed/*_index.*'
      - 'feldtheorie_index.*'

jobs:
  sigillin-parity:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v5

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install pyyaml jsonschema

    - name: Run Sigillin Sync Report
      id: sync_report
      run: |
        python scripts/sigillin_sync.py report \
          --roots seed/bedeutungssigillin \
          --roots seed/shadow_sigillin \
          --output /tmp/sigillin_sync_ci.json

        # Check if report was generated
        if [ ! -f /tmp/sigillin_sync_ci.json ]; then
          echo "âŒ Sigillin sync report not generated"
          exit 1
        fi

        # Parse gaps from report
        GAPS=$(python -c "import json; f=open('/tmp/sigillin_sync_ci.json'); d=json.load(f); print(sum(len(t['gaps']) for t in d.get('trilayers', [])))")
        echo "gaps=$GAPS" >> $GITHUB_OUTPUT

        echo "ğŸ“Š Sigillin Sync Report:"
        cat /tmp/sigillin_sync_ci.json

    - name: Check for Trilayer Gaps
      run: |
        GAPS=${{ steps.sync_report.outputs.gaps }}
        echo "ğŸ” Detected $GAPS trilayer gap(s)"

        if [ "$GAPS" -gt 0 ]; then
          echo "âŒ FAIL: Trilayer gaps detected!"
          echo "Please ensure all YAML/JSON/MD triplets are synchronized."
          echo "Run: python scripts/sigillin_sync.py report --roots seed/"
          exit 1
        else
          echo "âœ… PASS: All trilayers in sync (0 gaps)"
        fi

    - name: Check Index Parity
      run: |
        # Run archive_sigillin.py --recount to check index drift
        python scripts/archive_sigillin.py --recount || {
          echo "âŒ FAIL: Index recount found discrepancies"
          echo "Run: python scripts/archive_sigillin.py --recount"
          exit 1
        }
        echo "âœ… PASS: Index parity maintained"

    - name: Summary
      if: success()
      run: |
        echo "ğŸŒŠ Sigillin Health Check: PASSED"
        echo ""
        echo "Ïƒ(Î²(R-Î˜)) remains resonant:"
        echo "  - Trilayer parity: âœ…"
        echo "  - Index synchronization: âœ…"
        echo "  - Shadow handshake: âœ…"
        echo ""
        echo "The membrane breathes. Î²â‰ˆ4.6 holds the transition sharp."
